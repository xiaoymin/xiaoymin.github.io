<!DOCTYPE html>
<html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <title>åŸºäºApple MLXæ¡†æ¶çš„M1è®¾å¤‡ä¸Šå¤§æ¨¡å‹å¾®è°ƒå®è·µ &mdash; å…«ä¸€èœåˆ€</title>
    <link rel="stylesheet" href="http://localhost:4000/assets/vendor/primer-css/css/primer.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/vendor/primer-markdown/dist/user-content.min.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/vendor/octicons/octicons/octicons.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/components/collection.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/components/repo-card.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/sections/repo-list.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/sections/mini-repo-list.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/components/boxed-group.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/globals/common.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/vendor/share.js/dist/css/share.min.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/globals/responsive.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/posts/index.css">
    <!-- Latest compiled and minified CSS -->
    

    
    <link rel="canonical" href="http://localhost:4000/2023/12/17/apple-mlx-lora-action/">
    <link rel="alternate" type="application/atom+xml" title="å…«ä¸€èœåˆ€" href="http://localhost:4000/feed.xml">
    <link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
    
    <meta property="og:title" content="åŸºäºApple MLXæ¡†æ¶çš„M1è®¾å¤‡ä¸Šå¤§æ¨¡å‹å¾®è°ƒå®è·µ">
      
    <meta name="keywords" content="["Apple MLXæ¡†æ¶", "M1è®¾å¤‡", "M1è®¾å¤‡å¾®è°ƒ", "å¤§æ¨¡å‹å¾®è°ƒ", "Mistral 7Bæ¨¡å‹", "è®­ç»ƒå‚æ•°è°ƒæ•´", "æ•°æ®é›†å¾®è°ƒ"]">
    <meta name="og:keywords" content="["Apple MLXæ¡†æ¶", "M1è®¾å¤‡", "M1è®¾å¤‡å¾®è°ƒ", "å¤§æ¨¡å‹å¾®è°ƒ", "Mistral 7Bæ¨¡å‹", "è®­ç»ƒå‚æ•°è°ƒæ•´", "æ•°æ®é›†å¾®è°ƒ"]">
      
    <meta name="description" content="å‰è¨€">
    <meta name="og:description" content="å‰è¨€">
      
    
    
        
    
    <meta property="og:url" content="http://localhost:4000/2023/12/17/apple-mlx-lora-action/">
    <meta property="og:site_name" content="å…«ä¸€èœåˆ€">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="zh_CN" />
    
    <meta property="article:published_time" content="2023-12-17">
    
    <script src="http://localhost:4000/assets/vendor/jquery/dist/jquery.min.js"></script>
    <script src="http://localhost:4000/assets/js/jquery-ui.js"></script>
    <script src="http://localhost:4000/assets/js/main.js"></script>
</head>
<body class="" data-mz="">
    <header class="site-header">
        <div class="container">
            <h1><a href="http://localhost:4000/" title="å…«ä¸€èœåˆ€"><span class="octicon octicon-mark-github"></span> å…«ä¸€èœåˆ€</a></h1>
            <button class="collapsed mobile-visible" type="button" onclick="toggleMenu();">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <nav class="site-header-nav" role="navigation">
                
                <a href="http://localhost:4000/" class=" site-header-nav-item" target="" title="é¦–é¡µ">é¦–é¡µ</a>
                
                <a href="http://localhost:4000/categories/" class=" site-header-nav-item" target="" title="åˆ†ç±»">åˆ†ç±»</a>
                
                <a href="http://localhost:4000/archives/" class=" site-header-nav-item" target="" title="å½’æ¡£">å½’æ¡£</a>
                
                <a href="http://localhost:4000/about/" class=" site-header-nav-item" target="" title="å…³äº">å…³äº</a>
                
            </nav>
        </div>
    </header>
    <!-- / header -->

    <section class="collection-head small geopattern" data-pattern-id="åŸºäºApple MLXæ¡†æ¶çš„M">
<div class="container">
  <div class="columns">
    <div class="column three-fourths">
      <div class="collection-title">
        <h1 class="collection-header">åŸºäºApple MLXæ¡†æ¶çš„M1è®¾å¤‡ä¸Šå¤§æ¨¡å‹å¾®è°ƒå®è·µ</h1>
        <div class="collection-info">
          
          <span class="meta-info">
            <span class="octicon octicon-calendar"></span> 2023/12/17
          </span>
          
          
          <span class="meta-info">
            <span class="octicon octicon-file-directory"></span>
            <a href="http://localhost:4000/categories/#å¤§æ¨¡å‹" title="å¤§æ¨¡å‹">å¤§æ¨¡å‹</a>
          </span>
          
          <span class="meta-info">
            <!--<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>-->
            <span id="busuanzi_container_page_pv"> æµè§ˆ<span id="busuanzi_value_page_pv"></span>æ¬¡</span>
          </span>
        </div>
      </div>
    </div>
  </div>
</div>
</section>
<!-- / .banner -->
<section class="container content">
<div class="columns">
  <div class="column three-fourths" >
    <article class="article-content markdown-body">
    <h2 id="å‰è¨€">å‰è¨€</h2>

<p>åœ¨ä¸ä¹…å‰è‹¹æœå®˜æ–¹å¼€æºå‘å¸ƒäº†é’ˆå¯¹Apple Silicon èŠ¯ç‰‡ä¼˜åŒ–çš„ MLX æ·±åº¦å­¦ä¹ æ¡†æ¶ï¼Œè¯¥æ¡†æ¶å¯ä»¥ç®€åŒ–ç ”ç©¶äººå‘˜åœ¨ Macã€iPadã€iPhone å¹³å°è®¾è®¡å’Œéƒ¨ç½²æ¨¡å‹çš„è¿‡ç¨‹ã€‚</p>

<p>MLXçš„ä¸»è¦ç‰¹æ€§åŒ…æ‹¬ï¼š</p>

<ul>
  <li><strong>ç†Ÿæ‚‰çš„API</strong>ï¼š<strong>MLX</strong> å…·æœ‰ç´§éš NumPy çš„ Python APIã€‚ MLX è¿˜æ‹¥æœ‰åŠŸèƒ½é½å…¨çš„ C++ APIï¼Œå®ƒä¸ Python API éå¸¸ç›¸ä¼¼ã€‚ MLX å…·æœ‰ <code class="language-plaintext highlighter-rouge">mlx.nn</code> å’Œ <code class="language-plaintext highlighter-rouge">mlx.optimizers</code> ç­‰æ›´é«˜çº§åˆ«çš„åŒ…ï¼Œå…¶ API ç´§å¯†éµå¾ª PyTorchï¼Œä»¥ç®€åŒ–æ„å»ºæ›´å¤æ‚çš„æ¨¡å‹ã€‚</li>
  <li><strong>å¯ç»„åˆå‡½æ•°è½¬æ¢</strong>ï¼šMLX å…·æœ‰ç”¨äºè‡ªåŠ¨å¾®åˆ†ã€è‡ªåŠ¨çŸ¢é‡åŒ–å’Œè®¡ç®—å›¾ä¼˜åŒ–çš„å¯ç»„åˆå‡½æ•°è½¬æ¢</li>
  <li><strong>æƒ°æ€§è®¡ç®— (Lazy computation)</strong>ï¼šMLX ä¸­çš„è®¡ç®—æ˜¯æƒ°æ€§è®¡ç®—ã€‚æ•°ç»„ä»…åœ¨éœ€è¦æ—¶æ‰ä¼šå…·ä½“åŒ–</li>
  <li><strong>åŠ¨æ€å›¾æ„å»º</strong>ï¼šMLX ä¸­çš„è®¡ç®—å›¾é‡‡ç”¨åŠ¨æ€æ„å»ºï¼Œæ›´æ”¹å‡½æ•°å‚æ•°çš„å½¢çŠ¶ä¸ä¼šè§¦å‘ç¼“æ…¢çš„ç¼–è¯‘ï¼Œå¹¶ä¸”è°ƒè¯•ç®€å•ç›´è§‚</li>
  <li><strong>å¤šè®¾å¤‡ï¼š</strong>å¯ä»¥åœ¨ä»»ä½•æ”¯æŒçš„è®¾å¤‡ä¸Šè¿è¡Œï¼ˆå½“å‰ä¸º CPU å’Œ GPUï¼‰ï¼Œç¡®ä¿ç”¨æˆ·èƒ½å¤Ÿå……åˆ†åˆ©ç”¨ç¡¬ä»¶</li>
  <li><strong>å…·å¤‡ç»Ÿä¸€å†…å­˜ä¼˜åŠ¿</strong>ï¼šMLX å’Œå…¶ä»–æ¡†æ¶çš„æ˜¾ç€åŒºåˆ«æ˜¯é‡‡ç”¨ç»Ÿä¸€å†…å­˜æ¨¡å‹ã€‚ MLX ä¸­çš„æ•°ç»„ä½äºå…±äº«å†…å­˜ä¸­ï¼Œå¯ä»¥åœ¨ä»»ä½•æ”¯æŒçš„è®¾å¤‡ç±»å‹ä¸Šæ‰§è¡Œ MLX é˜µåˆ—ä¸Šçš„æ“ä½œï¼Œè€Œæ— éœ€ç§»åŠ¨æ•°æ®ã€‚</li>
</ul>

<p>é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/ml-explore/mlx">https://github.com/ml-explore/mlx</a></p>

<p>è€Œåœ¨ä»Šå¤©çš„Xä¸Šçœ‹åˆ°Appleå¼€å‘è€…åˆ†äº«è¯´å¯ä»¥åœ¨32GBçš„M1è®¾å¤‡ä¸Šä½¿ç”¨MLXæ¡†æ¶å¯¹Mistral 7B(æˆ–è€…llamA)ç­‰æ¨¡å‹è¿›è¡Œå¾®è°ƒ(Fine-tune)</p>

<p><img src="/assets/images/llm/apple-mlx-lora-action/image-20231216193342777.png" alt="image-20231216193342777" /></p>

<h2 id="å‡†å¤‡">å‡†å¤‡</h2>

<p>çœ‹åˆ°å®˜æ–¹çš„ä¾‹å­ï¼Œæˆ‘çš„ç”µè„‘æ­£å¥½æ˜¯M1 32GBçš„é…ç½®ï¼Œå°±æŠŠä»£ç è·‘æ¥è¯•è¯•çœ‹</p>

<p>é¦–å…ˆä»£ç ä¸‹è½½ä¸‹æ¥ï¼Œåœ°å€ï¼š<a href="https://github.com/ml-explore/mlx-examples/tree/main/lora">https://github.com/ml-explore/mlx-examples/tree/main/lora</a></p>

<p>å®‰è£…ä¾èµ–ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install</span> <span class="nt">-r</span> requirements.txt
</code></pre></div></div>

<p>ä¸‹è½½Mistral-7B(14.48GBå¤§å°)çš„æ¨¡å‹å¹¶è§£å‹</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-O</span> https://files.mistral-7b-v0-1.mistral.ai/mistral-7B-v0.1.tar
<span class="nb">tar</span> <span class="nt">-xf</span> mistral-7B-v0.1.tar
</code></pre></div></div>

<p>å°†ä¸‹è½½ä¸‹æ¥çš„æ¨¡å‹æ–‡ä»¶è¿›è¡Œè½¬æ¢ï¼Œæ‰§è¡Œ<code class="language-plaintext highlighter-rouge">convert.py</code>æ–‡ä»¶, å‘½ä»¤å¦‚ä¸‹ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># è½¬æ¢å‘½ä»¤</span>
python convert.py <span class="se">\</span>
    <span class="nt">--torch-model</span> &lt;path_to_torch_model&gt; <span class="se">\</span>
    <span class="nt">--mlx-model</span> &lt;path_to_mlx_model&gt;
<span class="c"># è½¬æ¢</span>
python convert.py <span class="se">\</span>
<span class="nt">--torch-model</span> mistral-7B-v0.1 <span class="se">\</span>
<span class="nt">--mlx-model</span> mistral-7b-v0.1-mlx
</code></pre></div></div>

<p>ä¸¤ä¸ªä¸»è¦çš„å‚æ•°:</p>

<ul>
  <li>torch-model: Mistralæ¨¡å‹çš„ç›®å½•ï¼Œè§£å‹åä¸ºå½“å‰çš„<code class="language-plaintext highlighter-rouge">mistral-7B-v0.1</code></li>
  <li>mlx-model: è¾“å‡ºç›®å½•åç§°ï¼Œè¿™é‡Œå–å<code class="language-plaintext highlighter-rouge">mistral-7b-v0.1-mlx</code></li>
</ul>

<p>é€šè¿‡å‘½ä»¤è½¬æ¢åï¼Œè½¬æ¢çš„ç›®å½•æ–‡ä»¶ä¼šæœ‰ä¸‰ä¸ªæ–‡ä»¶ï¼Œå¦‚ä¸‹å›¾ï¼š</p>

<p><img src="/assets/images/llm/apple-mlx-lora-action/image-20231216201202978.png" alt="image-20231216201202978" /></p>

<h2 id="å¾®è°ƒfine-tune">å¾®è°ƒ(Fine-tune)</h2>

<p>å°†æ¨¡å‹ä¸‹è½½è½¬æ¢å®Œæˆåï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥ä½¿ç”¨å®˜æ–¹æä¾›çš„<code class="language-plaintext highlighter-rouge">lora.py</code>è¿›è¡Œå¾®è°ƒ(<strong>Fine-tune</strong>)äº†ï¼Œå…ˆæ¥çœ‹æ•°æ®é›†ï¼š</p>

<p><img src="/assets/images/llm/apple-mlx-lora-action/image-20231216194706972.png" alt="image-20231216194706972" /></p>

<p>è®­ç»ƒçš„æ•°æ®é›†æ˜¯1000è¡Œï¼Œä¸»è¦çš„æ ¼å¼ï¼š</p>

<blockquote>
  <p>å¾®è°ƒç›®æ ‡æ˜¯å¾—åˆ°ä¸€ä¸ªèƒ½å¤Ÿå°†è‡ªç„¶è¯­è¨€å¥å­è½¬æ¢ä¸ºSQL</p>
</blockquote>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"table: 1-1000181-1</span><span class="se">\n</span><span class="s2">columns: State/territory, Text/background colour, Format, Current slogan, Current series, Notes</span><span class="se">\n</span><span class="s2">Q: Tell me what the notes are for South Australia </span><span class="se">\n</span><span class="s2">A: SELECT Notes FROM 1-1000181-1 WHERE Current slogan = 'SOUTH AUSTRALIA'"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>æ•°æ®é›†çš„æ ¼å¼å¾ˆæ¸…æ™°ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>table: è¡¨åç§°
columns: åˆ—åç§°
Q: ç”¨æˆ·é—®é¢˜
A: SQLè¯­å¥
</code></pre></div></div>

<h2 id="è®­ç»ƒ">è®­ç»ƒ</h2>

<p>åœ¨ç¬¬ä¸€æ¬¡trainçš„è¿‡ç¨‹ä¸­ï¼Œç›´æ¥ä½¿ç”¨demoä¸­çš„å‘½ä»¤ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python lora.py <span class="nt">--model</span> &lt;path_to_model&gt; <span class="se">\</span>
               <span class="nt">--train</span> <span class="se">\</span>
               <span class="nt">--iters</span> 600
</code></pre></div></div>

<p>è¿è¡Œäº†å¤§æ¦‚10åˆ†é’Ÿåï¼Œç¨‹åºå°±å¼‚å¸¸é€€å‡ºäº†ï¼Œæç¤ºå†…å­˜ä¸è¶³ã€‚</p>

<p><img src="/assets/images/llm/apple-mlx-lora-action/image-20231216195734079.png" alt="image-20231216195734079" /></p>

<p>ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œåœ¨å£°æ˜å†…å­˜çš„è¿‡ç¨‹ä¸­ï¼Œå‡ºç°äº†å¼‚å¸¸ï¼Œæ— æ³•å¼€è¾Ÿæ–°å†…å­˜ç©ºé—´ï¼Œå¹¶ä¸”æ¯ç§’çš„Tokensæ•°é‡ä¹Ÿå¾ˆæ„ŸäººğŸ˜­</p>

<p>åœ¨çœ‹äº†å®˜æ–¹çš„é’ˆå¯¹å†…å­˜çš„issueså»ºè®®åï¼Œå‘ç°æœ‰å‡ ä¸ªå‚æ•°æ˜¯å½±å“ç€å†…å­˜ä½¿ç”¨çš„ï¼š</p>

<ul>
  <li><strong>â€“batch-size</strong>ï¼šå°è¯•é€šè¿‡ <code class="language-plaintext highlighter-rouge">--batch-size</code> ä½¿ç”¨è¾ƒå°çš„æ‰¹é‡å¤§å°ã€‚ é»˜è®¤å€¼ä¸º 4ï¼Œå› æ­¤å°†å…¶è®¾ç½®ä¸º 2 æˆ– 1 å°†å‡å°‘å†…å­˜æ¶ˆè€—ã€‚ è¿™å¯èƒ½ä¼šå‡æ…¢é€Ÿåº¦ï¼Œä½†ä¹Ÿä¼šå‡å°‘å†…å­˜ä½¿ç”¨ã€‚</li>
  <li><strong>â€“lora-layers</strong>:å°‘å±‚æ•°ä»¥ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">--lora-layers</code> è¿›è¡Œå¾®è°ƒã€‚ é»˜è®¤å€¼ä¸º 16ï¼Œå› æ­¤æ‚¨å¯ä»¥å°è¯• 8 æˆ– 4ã€‚è¿™ä¼šå‡å°‘åå‘ä¼ æ’­æ‰€éœ€çš„å†…å­˜é‡ã€‚ å¦‚æœæ‚¨ä½¿ç”¨å¤§é‡æ•°æ®è¿›è¡Œå¾®è°ƒï¼Œå®ƒè¿˜å¯èƒ½ä¼šé™ä½å¾®è°ƒæ¨¡å‹çš„è´¨é‡ã€‚</li>
  <li>æ•°æ®é›†ï¼šè¾ƒé•¿çš„ç¤ºä¾‹éœ€è¦æ›´å¤šçš„å†…å­˜ã€‚ å¦‚æœè¿™å¯¹æ‚¨çš„æ•°æ®æœ‰æ„ä¹‰ï¼Œæ‚¨å¯ä»¥åšçš„ä¸€ä»¶äº‹æ˜¯åœ¨åˆ¶ä½œ {train, valid, test}.jsonl æ–‡ä»¶æ—¶å°†ç¤ºä¾‹åˆ†è§£ä¸ºæ›´å°çš„åºåˆ—ã€‚</li>
</ul>

<p>æ ¹æ®å®˜æ–¹çš„å»ºè®®ï¼Œé‚£ä¹ˆä¿®æ”¹trainå‚æ•°ï¼Œå¦‚ä¸‹ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python lora.py <span class="se">\</span>
   <span class="nt">--model</span> mistral-7b-v0.1-mlx <span class="se">\</span>
   <span class="nt">--train</span> <span class="se">\</span>
   <span class="nt">--batch-size</span> 1 <span class="se">\</span>
   <span class="nt">--lora-layers</span> 4
</code></pre></div></div>

<p>æŒ‰è¿™ä¸ªå‘½ä»¤æ‰§è¡Œåï¼Œåœ¨æˆ‘çš„M1è®¾å¤‡ä¸Šæ‰§è¡Œçš„è¿˜æ¯”è¾ƒå¿«ï¼Œæ¯ç§’çš„Tokensæ•°é‡å¹³å‡ä¸Š110å·¦å³</p>

<p><img src="/assets/images/llm/apple-mlx-lora-action/image-20231216200532260.png" alt="image-20231216200532260" /></p>

<p>è€ŒLossçš„å€¼å¦‚ä¸‹ï¼š</p>

<table>
  <thead>
    <tr>
      <th>Iter</th>
      <th>Loss</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>2.265</td>
    </tr>
    <tr>
      <td>200</td>
      <td>1.516</td>
    </tr>
    <tr>
      <td>400</td>
      <td>1.380</td>
    </tr>
    <tr>
      <td>600</td>
      <td>1.350</td>
    </tr>
    <tr>
      <td>800</td>
      <td>1.325</td>
    </tr>
  </tbody>
</table>

<p>trainå®Œæˆåï¼Œä¼šåœ¨æœ¬åœ°é»˜è®¤ç”Ÿæˆä¸€ä¸ªæƒé‡æ–‡ä»¶<code class="language-plaintext highlighter-rouge">adapters.npz</code></p>

<p>æµ‹è¯•ç»“æœï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python lora.py <span class="nt">--model</span> mistral-7b-v0.1-mlx <span class="se">\</span>
               <span class="nt">--adapter-file</span> adapters.npz <span class="se">\</span>
               <span class="nt">--num-tokens</span> 50 <span class="se">\</span>
               <span class="nt">--prompt</span> <span class="s2">"table: 1-10015132-16
columns: Player, No., Nationality, Position, Years in Toronto, School/Club Team
Q: What is terrence ross' nationality
A: "</span>
Loading pretrained model
Total parameters 7243.436M
Trainable parameters 1.704M
Loading datasets
Generating
table: 1-10015132-16
columns: Player, No., Nationality, Position, Years <span class="k">in </span>Toronto, School/Club Team
Q: What is terrence ross<span class="s1">' nationality
# å¤§æ¨¡å‹è¾“å‡º
A:  SELECT Nationality FROM 1-10015132-16 WHERE Player = '</span>Terrence Ross<span class="s1">' blowing off the rosshill. SELECT Nationality FROM 1-10015
</span></code></pre></div></div>

<p>ä»ç»“æœçœ‹ï¼ŒSQLçš„å‰åŠéƒ¨åˆ†å†™å¯¹äº†ï¼Œå¹¶ä¸”ä¹Ÿè¯†åˆ«å‡ºäº†å­—æ®µã€whereæ¡ä»¶ï¼Œä½†æ˜¯åé¢çš„å¥å­å¥½åƒå°±ä¸å¤ªå¯¹äº†</p>

<p>æˆ‘æ€€ç–‘æ˜¯åœ¨trainæ—¶ï¼Œå‚æ•°<code class="language-plaintext highlighter-rouge">--lora-layers 4</code>çš„é—®é¢˜ï¼Œè¿™æ—¶ï¼Œæˆ‘å°†æ”¹å‚æ•°æ”¹ä¸º8ï¼Œåœ¨trainä¸€æ¬¡</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python lora.py <span class="se">\</span>
   <span class="nt">--model</span> mistral-7b-v0.1-mlx <span class="se">\</span>
   <span class="nt">--train</span> <span class="se">\</span>
   <span class="nt">--adapter-file</span> adapters_2_8_1.npz <span class="se">\</span>
   <span class="nt">--batch-size</span> 2 <span class="se">\</span>
   <span class="nt">--lora-layers</span> 8
</code></pre></div></div>

<p>è€ŒLossçš„å€¼å¦‚ä¸‹ï¼š</p>

<table>
  <thead>
    <tr>
      <th>Iter</th>
      <th>loss</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>2.348</td>
    </tr>
    <tr>
      <td>200</td>
      <td>1.392</td>
    </tr>
    <tr>
      <td>400</td>
      <td>1.293</td>
    </tr>
    <tr>
      <td>800</td>
      <td>1.213</td>
    </tr>
    <tr>
      <td>1000</td>
      <td>1.233</td>
    </tr>
  </tbody>
</table>

<p>ä¹‹åï¼ŒåŒæ ·çš„å‘½ä»¤ï¼Œå†æ¥çœ‹æ•ˆæœï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python lora.py <span class="nt">--model</span> mistral-7b-v0.1-mlx <span class="se">\</span>
               <span class="nt">--adapter-file</span> adapters_2_8.npz <span class="se">\</span>
               <span class="nt">--num-tokens</span> 50 <span class="se">\</span>
               <span class="nt">--prompt</span> <span class="s2">"table: 1-10015132-16
columns: Player, No., Nationality, Position, Years in Toronto, School/Club Team
Q: What is terrence ross' nationality
A: "</span>
Loading pretrained model
Total parameters 7243.436M
Trainable parameters 1.704M
Loading datasets
Generating
table: 1-10015132-16
columns: Player, No., Nationality, Position, Years <span class="k">in </span>Toronto, School/Club Team
Q: What is terrence ross<span class="s1">' nationality
A:  SELECT Nationality FROM 1-10015132-16 WHERE Player = '</span>Terrence Ross<span class="s1">' SELECT Nationality FROM 1-10015132-16 WHERE
</span></code></pre></div></div>

<p>çœ‹æ•ˆæœå¥½åƒåœ¨SQLè¯­å¥ä¸­ï¼Œæ¯”ä¸Šé¢çš„æ•ˆæœç¨å¾®è¦å¥½ä¸€ç‚¹äº†?ä½†æ˜¯ç»“æœè¿˜æ˜¯ä¸å¯¹ã€‚</p>

<p>æ•ˆæœå¹¶æ²¡æœ‰è¾¾åˆ°é¢„æœŸï¼Œæˆ‘è§‰å¾—ä¸»è¦æ˜¯å¯èƒ½æœ‰å‡ ä¸ªæ–¹é¢çš„åŸå› ï¼š</p>

<ul>
  <li>è®­ç»ƒæ•°æ®é›†å¤ªå°‘ï¼Œå¯¼è‡´å¤§æ¨¡å‹å¯èƒ½æ— æ³•,train.jsonlä¸­çš„æ•°æ®é›†æ˜¯1000</li>
  <li>å‚æ•°<code class="language-plaintext highlighter-rouge">--lora-layers </code>çš„é—®é¢˜ï¼Œé»˜è®¤æ˜¯16ï¼Œè™½ç„¶æˆ‘æœ€åæ”¹æˆäº†8ï¼Œä½†æ˜¯ä»å®˜æ–¹ç»™å‡ºçš„è¯´æ˜æ¥çœ‹ï¼Œè¯¥å‚æ•°ä¼šå½±å“è´¨é‡</li>
</ul>

<p>æˆ‘å°†å‚æ•°<code class="language-plaintext highlighter-rouge">--lora-layers </code>ä¿®æ”¹ä¸º16è¿›è¡Œäº†å°è¯•ï¼Œè·‘ä¸äº†ï¼Œå¯èƒ½è¿˜æ˜¯æˆ‘çš„å†…å­˜å¤ªä½äº†ğŸ˜­ï¼Œé‚£æˆ‘åªèƒ½åŠ æ•°æ®é›†äº†</p>

<p>ä¿®æ”¹äº†dataç›®å½•ä¸‹çš„wikisql.pyæ–‡ä»¶ï¼Œå°†æ•°æ®é›†ä¸‹è½½æ•´ç†çš„æ€»ä½“æ•°é‡ä¸Šå‡åˆ°10000ï¼Œä»£ç ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">datanames</span> <span class="o">=</span> <span class="p">[</span><span class="s">"train"</span><span class="p">,</span> <span class="s">"dev"</span><span class="p">,</span> <span class="s">"test"</span><span class="p">]</span>
    <span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">56355</span><span class="p">,</span> <span class="mi">8421</span><span class="p">,</span> <span class="mi">15878</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">dataname</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">datanames</span><span class="p">,</span> <span class="n">sizes</span><span class="p">):</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">WikiSQL</span><span class="p">(</span><span class="n">dataname</span><span class="p">))</span> <span class="o">==</span> <span class="n">size</span><span class="p">,</span> <span class="sa">f</span><span class="s">"Wrong </span><span class="si">{</span><span class="n">dataname</span><span class="si">}</span><span class="s"> set size."</span>

    <span class="c1"># Write the sets to jsonl
</span>    <span class="kn">import</span> <span class="nn">json</span>

    <span class="n">train</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">load</span><span class="p">()</span>
    <span class="c1"># æ­¤å¤„åŸtrainå‚æ•°æ˜¯1000ï¼Œæˆ‘æ”¹æˆ5000
</span>    <span class="n">datasets</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="s">"train"</span><span class="p">,</span> <span class="mi">10000</span><span class="p">),</span>
        <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">"valid"</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span>
        <span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="s">"test"</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s">"data/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s">.jsonl"</span><span class="p">,</span> <span class="s">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">),</span> <span class="n">dataset</span><span class="p">):</span>
                <span class="c1"># Strip the &lt;s&gt;, &lt;/s&gt; since the tokenizer adds them
</span>                <span class="n">json</span><span class="p">.</span><span class="n">dump</span><span class="p">({</span><span class="s">"text"</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">]},</span> <span class="n">fid</span><span class="p">)</span>
                <span class="n">fid</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<p>ä¿®æ”¹æ•°æ®é›†åï¼Œåœ¨trainè¿‡åï¼Œå¾—åˆ°ä¸€ä¸ªæ–°çš„æƒé‡æ–‡ä»¶ï¼Œå‘½ä»¤ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python lora.py <span class="se">\</span>
   <span class="nt">--model</span> mistral-7b-v0.1-mlx <span class="se">\</span>
   <span class="nt">--train</span> <span class="se">\</span>
   <span class="nt">--adapter-file</span> adapters_2_8_1.npz <span class="se">\</span>
   <span class="nt">--batch-size</span> 2 <span class="se">\</span>
   <span class="nt">--lora-layers</span> 8
</code></pre></div></div>

<p>lossçš„trainè¿‡ç¨‹åˆ†å€¼å˜åŒ–ï¼š</p>

<table>
  <thead>
    <tr>
      <th>Iter</th>
      <th>loss</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>2.348</td>
    </tr>
    <tr>
      <td>200</td>
      <td>1.472</td>
    </tr>
    <tr>
      <td>400</td>
      <td>1.410</td>
    </tr>
    <tr>
      <td>600</td>
      <td>1.387</td>
    </tr>
    <tr>
      <td>800</td>
      <td>1.360</td>
    </tr>
    <tr>
      <td>1000</td>
      <td>1.349</td>
    </tr>
  </tbody>
</table>

<p>å†æ¥çœ‹çœ‹æˆ‘ä»¬çš„promtå¾—åˆ°çš„ç»“æœï¼š</p>

<p><img src="/assets/images/llm/apple-mlx-lora-action/image-20231217105402278.png" alt="image-20231217105402278" /></p>

<p>ä»ç»“æœæ¥çœ‹ï¼ŒSQLè¯­å¥çš„è¯­æ³•å¥½åƒå¹¶æ²¡æœ‰ä»€ä¹ˆå¤§çš„é—®é¢˜ï¼Œåªæ˜¯ç»“æœæ²¡æœ‰è¾¾åˆ°é¢„æœŸï¼Œå¯èƒ½è¿˜æ˜¯å¾—ä»æ•°æ®é›†åŠç›¸å…³å‚æ•°æ‰¾ä¸€ä¸‹åŸå› ã€‚</p>

<h2 id="ç»“è®º">ç»“è®º</h2>

<p>è™½ç„¶è¿è¡Œçš„ç»“æœè¿˜æ²¡æœ‰å®Œå…¨è¾¾åˆ°é¢„æœŸï¼Œä½†æ˜¯åœ¨MACä¸Šé€šè¿‡Appleæ¨å‡ºçš„MLXæ·±åº¦å­¦ä¹ æ¡†æ¶è¿›è¡ŒFine-tureçš„æŠ€æœ¯æ–¹æ¡ˆæ˜¯å¯è¡Œçš„ã€‚</p>

<p>è¿™ä¹Ÿä¸ºä»¥åå¤§æ¨¡å‹çš„è®­ç»ƒã€ç”Ÿæ€å‘å±•æä¾›äº†å¦å¤–ä¸€ç§å¯èƒ½æ€§ã€‚</p>

<p>åŒ…æ‹¬æˆ‘ä»¬åº”ç”¨å¼€å‘è€…åœ¨åšRAGçš„è¿‡ç¨‹ä¸­ï¼Œå’Œæ•°æ®è¿›è¡Œå¯¹è¯çš„åœºæ™¯éšç€ä¸šåŠ¡çš„æ·±å…¥è‚¯å®šä¼šè§¦åŠï¼Œè€Œå¯¹æ¨¡å‹è¿›è¡Œå¾®è°ƒæ˜¯ä¸å¯é¿å…çš„ã€‚</p>

<h2 id="reference">Reference</h2>

<ul>
  <li><a href="https://github.com/ml-explore/mlx-examples/tree/main/lora">https://github.com/ml-explore/mlx-examples/tree/main/lora</a></li>
  <li><a href="https://github.com/ml-explore/mlx">https://github.com/ml-explore/mlx</a></li>
  <li><a href="https://twitter.com/awnihannun/status/1735782998623261071">https://twitter.com/awnihannun/status/1735782998623261071</a></li>
</ul>

    </article>
    <div class="share">
      <div class="share-component"></div>
    </div>
    <div class="comment">
      

  

  
        <div id="gitalk-container"></div>
        <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
        <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
        <script>
        var gitalk = new Gitalk({
            id: '/2023/12/17/apple-mlx-lora-action/',
            clientID: 'af23e0d8d5f41c7b3719',
            clientSecret: '822f4fcf8e75da6193bd6f26bab3111ecce89142',
            repo: 'blog-comments',
            owner: 'xiaoymin',
            admin: ['xiaoymin'],
            labels: ['gitment'],
            perPage: 50,
        })
        gitalk.render('gitalk-container')
        </script>
  


    </div>
  </div>
  <div class="column one-fourth">
    
<h3>ç«™å†…æœç´¢</h3>
<div id="site_search">
    <input type="text" id="search_box" placeholder="æœç´¢">
</div>

<ul id="search_results"></ul>

<link rel="stylesheet" type="text/css" href="http://localhost:4000/assets/css/modules/sidebar-search.css">
<script src="http://localhost:4000/assets/js/simple-jekyll-search.min.js"></script>
<script src="http://localhost:4000/assets/js/search.js"></script>

<script type="text/javascript">
SimpleJekyllSearch({
    searchInput: document.getElementById('search_box'),
    resultsContainer: document.getElementById('search_results'),
    json: 'http://localhost:4000/assets/search_data.json',
    searchResultTemplate: '<li><a href="{url}" title="{desc}">{title}</a></li>',
    noResultsText: 'No results found',
    limit: 10,
    fuzzy: false,
    exclude: ['Welcome']
})
</script>

    

    <div class="xiaoym-qrcode">
  <div class="xiaoym-qrcode-title">
    <h2>å¾®ä¿¡å…¬ä¼—å·(å…«ä¸€èœåˆ€)</h2>
  </div>
  <div style="text-align: center;"><img src="/images/website/mp/qrcode_mini.jpg" /> </div>
</div>

<h3 class="post-directory-title mobile-hidden">Table of Contents</h3>
<div id="post-directory-module" class="mobile-hidden">
  <section class="post-directory">
    <!-- Links that trigger the jumping -->
    <!-- Added by javascript below -->
    <dl></dl>
  </section>
</div>


<script src="http://localhost:4000/assets/js/jquery.toc.js"></script>
  </div>
</div>
</section>
<!-- /section.content -->

    <footer class="container">
        <div class="site-footer" role="contentinfo">
            <div class="copyright left mobile-block">
                    Â© 2015
                    <span title="è‚–ç‰æ°‘">è‚–ç‰æ°‘</span>
                    <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a>
            </div>

            <ul class="site-footer-links right mobile-hidden">
                <li>
                    <a href="javascript:window.scrollTo(0,0)" >TOP</a>
                </li>
            </ul>
            <a href="https://github.com/xiaoymin/xiaoymin.github.io" target="_blank" aria-label="view source code">
                <span class="mega-octicon octicon-mark-github" title="GitHub"></span>
            </a>
            <ul class="site-footer-links mobile-hidden">
                
                <li>
                    <a href="http://localhost:4000/" title="é¦–é¡µ" target="">é¦–é¡µ</a>
                </li>
                
                <li>
                    <a href="http://localhost:4000/categories/" title="åˆ†ç±»" target="">åˆ†ç±»</a>
                </li>
                
                <li>
                    <a href="http://localhost:4000/archives/" title="å½’æ¡£" target="">å½’æ¡£</a>
                </li>
                
                <li>
                    <a href="http://localhost:4000/about/" title="å…³äº" target="">å…³äº</a>
                </li>
                
                <li><a href="http://localhost:4000/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li>
            </ul>

        </div>
        <div style="padding-bottom: 40px;
    font-size: 14px;
    height: 14px;
    vertical-align: middle;
    text-align: center;
    color: #999999;
    border-top: 1px solid #eee;">
            <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <span id="busuanzi_container_site_uv"> <strong>è®¿å®¢æ•°</strong> <span id="busuanzi_value_site_uv"></span></span>
            <span id="busuanzi_container_site_pv"> <strong>è®¿é—®é‡</strong> <span id="busuanzi_value_site_pv"></span></span>
        </div>
    </footer>
    <div class="tools-wrapper">
      <a class="gotop" href="#" title="å›åˆ°é¡¶éƒ¨"><span class="octicon octicon-arrow-up"></span></a>
    </div>
    <!-- / footer -->
    <script src="http://localhost:4000/assets/vendor/share.js/dist/js/share.min.js"></script>
    <script src="http://localhost:4000/assets/js/geopattern.js"></script>
    <script src="http://localhost:4000/assets/js/prism.js"></script>
    <link rel="stylesheet" href="http://localhost:4000/assets/css/globals/prism.css">
    <script>
      jQuery(document).ready(function($) {
        // geopattern
        $('.geopattern').each(function(){
          $(this).geopattern($(this).data('pattern-id'));
        });
       // hljs.initHighlightingOnLoad();
      });
    </script>

    

    

    

    

    
</body>
</html>
